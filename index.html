<html>
	<head>
		<link href="https://fonts.googleapis.com/css?family=Open+Sans|Open+Sans+Condensed:700" rel="stylesheet">
		<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
		<style>
			body {
				font-family: 'Open Sans', sans-serif;
			}

			h2 {
				font-family: 'Open Sans Condensed', sans-serif;
				font-weight: 700;
			}

			.card ul {
				list-style: none;
				margin: 0;
				padding: 0;
			}

			.card li {
				float: left;
				width: 50%;
			}

			.card li .image {
				background-position: 50%;
				background-size: cover;
				border: 1px solid #dcdcdc;
				width: 100px;
				height: 75px;
				float: left;
				margin-right: 20px;
			}

			.card-header {
				background: #1b7cf5;
				color: #ffffff;
				font-size: 28px;
				font-weight: bold;
			}

			.header {
				border-bottom: 1px solid #dcdcdc;
				font-weight: bold;
			}

			h3 small {
				font-size: 12px;
			}

			#weather_section {
				margin-bottom: 32px;
			}
		</style>
	</head>
	<body>
		<div class="container">
			<div class="card">
				<h5 class="card-header">Today at Walt Disney World - <span id="date"></span></h5>
				<div class="card-body">
					<div class="row">
						<div id="weather_section" class="col-sm-12">
							<h3 class="header">Current weather <small><a href="https://darksky.net/poweredby/">Powered by Dark Sky</a></small></h3>
							<div id="weather"></div>
						</div>
						<div class="col-sm-12">
							<h3 class="header">Today's Park Hours</h3>
							<ul id="parks"></ul>
						</div>
					</div>
				</div>
			</div>
		</div>

		<script type="text/javascript">
			const getParameterByName = (name) => {
				let url = window.location.href;
				name = name.replace(/[\[\]]/g, '\\$&');
				let regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
				results = regex.exec(url);
				if (!results) return null;
				if (!results[2]) return '';
				return decodeURIComponent(results[2].replace(/\+/g, ' '));
			}

			const fahrenheitToCelsius = (value) => {
				return ((value - 32) * (5/9)).toFixed();
			}

			const parks_ul = document.getElementById('parks');
			const weather_div = document.getElementById('weather');
			const destination = getParameterByName('destination') || 'wdw';
			const background = getParameterByName('background');

			const PARKS_API_URL = 'https://wdwntnowapi.azurewebsites.net/api/v2/mobile/parks';
			const WEATHER_API_URL = 'https://weather.wdwnt.com/api/' + destination;
			const BACKGROUND_IMAGE = '';

			const date_div = document.getElementById('date');
			date_div.innerHTML = new Date().toLocaleDateString();

			document.querySelector('body').style.backgroundImage = `url(${background})` || '';

			document.addEventListener('DOMContentLoaded', function() {
				fetch(PARKS_API_URL).then(res => res.json()).then((parks) => {
					// load the data into the page
					parks.filter((park) => {
						return park.destination === destination;
					}).forEach((park) => {
						const li = document.createElement('li');
						li.innerHTML = `
							<div class="image" style="background-image: url('${park.imageUrl}');"></div>
							<h3>${park.name}</h3>
							<p>Today's hours: ${park.todaysHours}</p>
						`;
						parks_ul.appendChild(li);
					});
				});

				fetch(WEATHER_API_URL).then(res => res.json()).then((weather) => {
					var currently = weather.currently;
					var summary = currently.summary.toLowerCase();
					var icon_url = `https://darksky.net/images/weather-icons/${currently.icon}.png`;
					var temperature_f = weather.currently.temperature.toFixed();
					var temperature_c = fahrenheitToCelsius(temperature_f);

					var hourly_summary = weather.hourly.summary.replace('.', '');

					var todays_weather = weather.daily.data[0];
					var todays_precipProbability = todays_weather.precipProbability * 100;
					var todays_high = todays_weather.temperatureHigh.toFixed();
					var todays_high_c = fahrenheitToCelsius(todays_high);
					var todays_low = todays_weather.temperatureLow.toFixed();
					var todays_low_c = fahrenheitToCelsius(todays_low);

					weather_div.innerHTML = `
						<div class="row align-items-center">
							<div class="col-sm-1"><img width="84" height="84" src=${icon_url} /></div>
							<div class="col-sm-11">
								<div><strong>${temperature_f}&deg;F (${temperature_c}&deg;C) and ${summary}</strong></div>
								<div>${hourly_summary} with a high of ${todays_high}&deg;F (${todays_high_c}&deg;C) and a low of ${todays_low}&deg;F (${todays_low_c}&deg;C). There is a ${todays_precipProbability}% chance of rain.</div>
							</div>
						</div>
					`;
				});
			}, false);
		</script>
	</body>
</html>
